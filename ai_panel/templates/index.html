<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI ãƒˆãƒªã‚ªå”è­°ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans','Meiryo',sans-serif;background:#f0f2f5;color:#1a1a2e;min-height:100vh}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 60%,#0f3460 100%);color:#fff;padding:20px 32px;box-shadow:0 2px 12px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:space-between}
header h1{font-size:20px;font-weight:700;letter-spacing:1px}
header p{font-size:12px;color:rgba(255,255,255,.55);margin-top:4px}
.btn-shutdown{background:rgba(220,50,50,.85);color:#fff;border:none;border-radius:8px;padding:9px 18px;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap}
.btn-shutdown:hover{background:rgba(220,50,50,1)}
.btn-test{background:rgba(255,255,255,.92);color:#1a1a2e;border:none;border-radius:8px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap}
.btn-test:hover{background:#fff}
.btn-test:disabled{opacity:.5;cursor:not-allowed}
/* ãƒ†ã‚¹ãƒˆçµæœãƒãƒ¼ */
.test-result-bar{display:none;background:rgba(0,0,0,.25);border-radius:8px;padding:10px 16px;margin-top:10px;font-size:12px;color:#fff;display:flex;gap:18px;flex-wrap:wrap}
.test-item{display:flex;align-items:center;gap:5px}
.test-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.test-dot.ok{background:#2ecc71}.test-dot.ng{background:#e74c3c}.test-dot.wait{background:#f39c12;animation:pulse .8s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€ */
main{max-width:1400px;margin:0 auto;padding:24px 16px}

/* â”€â”€ å…¥åŠ›ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.input-card{background:#fff;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px}
.input-card textarea{width:100%;min-height:90px;padding:13px;border:2px solid #e8eaed;border-radius:8px;font-size:15px;font-family:inherit;resize:vertical;line-height:1.7;transition:border-color .2s}
.input-card textarea:focus{outline:none;border-color:#4285f4}
.input-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.input-footer .hint{font-size:12px;color:#999}
.btn-start{background:linear-gradient(135deg,#4285f4,#0f3460);color:#fff;border:none;border-radius:8px;padding:11px 30px;font-size:15px;font-weight:700;cursor:pointer;transition:transform .15s,opacity .15s}
.btn-start:hover:not(:disabled){transform:translateY(-1px);opacity:.92}
.btn-start:disabled{opacity:.5;cursor:not-allowed}

/* â”€â”€ å‚è€ƒè³‡æ–™æ¬„ â”€â”€ */
.context-wrap{margin-top:12px;border-top:1px solid #f0f2f5;padding-top:12px}
.context-toggle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.context-label{font-size:13px;font-weight:600;color:#555;display:flex;align-items:center;gap:6px}
.btn-load-self{background:#f0f2f5;border:1px solid #ddd;border-radius:6px;padding:5px 12px;font-size:12px;cursor:pointer;color:#444;transition:background .15s}
.btn-load-self:hover{background:#e4e6e9}
.btn-load-self:disabled{opacity:.5;cursor:not-allowed}
.context-hint{font-size:11px;color:#aaa;margin-bottom:6px}
#context{width:100%;height:120px;padding:10px 13px;border:1px solid #e8eaed;border-radius:8px;font-size:12px;font-family:monospace;resize:vertical;color:#333;background:#fafbfc;line-height:1.6}
#context:focus{outline:none;border-color:#4285f4}

/* â”€â”€ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ â”€â”€ */
.progress-wrap{display:none;justify-content:center;align-items:center;margin-bottom:22px}
.progress-wrap.show{display:flex}
.prog-step{display:flex;flex-direction:column;align-items:center;gap:5px}
.prog-circle{width:34px;height:34px;border-radius:50%;border:3px solid #ddd;background:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#bbb;transition:all .3s}
.prog-step.active .prog-circle{border-color:#4285f4;background:#4285f4;color:#fff}
.prog-step.done   .prog-circle{border-color:#34a853;background:#34a853;color:#fff}
.prog-label{font-size:11px;color:#aaa;white-space:nowrap}
.prog-step.active .prog-label{color:#4285f4;font-weight:600}
.prog-step.done   .prog-label{color:#34a853}
.prog-line{width:64px;height:3px;background:#ddd;margin:0 6px 18px;transition:background .3s}
.prog-line.done{background:#34a853}

/* â”€â”€ ã‚¹ãƒ†ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â”€â”€ */
.step-section{display:none;margin-bottom:24px;animation:fadeUp .3s ease}
.step-section.show{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.step-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.step-badge{background:#1a1a2e;color:#fff;padding:3px 12px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:1px}
.step-title{font-size:17px;font-weight:700}

/* â”€â”€ AIã‚°ãƒªãƒƒãƒ‰ â”€â”€ */
.ai-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media(max-width:900px){.ai-grid{grid-template-columns:1fr}}

/* â”€â”€ AIã‚«ãƒ¼ãƒ‰ â”€â”€ */
.ai-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.ai-card-header{display:flex;align-items:center;gap:9px;padding:12px 16px;color:#fff;font-weight:700;font-size:14px}
.ai-card.chatgpt .ai-card-header{background:#10a37f}
.ai-card.gemini  .ai-card-header{background:#4285f4}
.ai-card.claude  .ai-card-header{background:#c96442}
.ai-icon{width:26px;height:26px;background:rgba(255,255,255,.22);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.model-label{font-size:10px;opacity:.75}

.ai-card-body{padding:14px 16px;font-size:13.5px;line-height:1.8;color:#333;min-height:140px;max-height:380px;overflow-y:auto}
.ai-card-body.loading{display:flex;align-items:center;justify-content:center;gap:10px;color:#aaa;min-height:140px}
.spinner{width:18px;height:18px;border:3px solid #e0e0e0;border-top-color:#4285f4;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

.ai-stats{display:flex;gap:14px;padding:7px 16px;background:#f8f9fa;border-top:1px solid #eee;font-size:11px;color:#777}

/* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…ã‚¹ã‚¿ã‚¤ãƒ« */
.ai-card-body h1,.ai-card-body h2,.ai-card-body h3{font-size:14px;margin:10px 0 5px;color:#1a1a2e}
.ai-card-body p{margin-bottom:8px}
.ai-card-body ul,.ai-card-body ol{margin:5px 0 8px 18px}
.ai-card-body li{margin-bottom:3px}
.ai-card-body strong{color:#1a1a2e}
.ai-card-body code{background:#f0f2f5;padding:1px 5px;border-radius:3px;font-size:12px}

/* â”€â”€ è²¢çŒ®åº¦ãƒãƒ£ãƒ¼ãƒˆ â”€â”€ */
.contrib-card{background:#fff;border-radius:12px;padding:18px 22px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:16px}
.contrib-title{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:7px}
.contrib-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.contrib-label{width:100px;font-size:12px;font-weight:600;color:#444;flex-shrink:0}
.contrib-bar-wrap{flex:1;background:#f0f2f5;border-radius:6px;height:22px;overflow:hidden}
.contrib-bar{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:11px;color:rgba(255,255,255,.9);font-weight:700;transition:width .9s cubic-bezier(.4,0,.2,1);min-width:28px}
.contrib-bar.chatgpt{background:#10a37f}
.contrib-bar.gemini {background:#4285f4}
.contrib-bar.claude {background:#c96442}
.contrib-meta{font-size:11px;color:#888;white-space:nowrap;width:160px;flex-shrink:0}

/* â”€â”€ æœ€çµ‚å›ç­” â”€â”€ */
.final-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.final-card-header{background:linear-gradient(135deg,#1a1a2e,#0f3460);color:#fff;padding:14px 20px;font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
.final-card-body{padding:20px;font-size:14.5px;line-height:1.85;color:#333}
.final-card-body h2{font-size:16px;font-weight:700;margin:16px 0 8px;color:#1a1a2e;border-bottom:2px solid #f0f2f5;padding-bottom:5px}
.final-card-body h3{font-size:14px;font-weight:700;margin:12px 0 5px;color:#444}
.final-card-body p{margin-bottom:9px}
.final-card-body ul,.final-card-body ol{margin:5px 0 9px 20px}
.final-card-body li{margin-bottom:4px}
.final-card-body strong{color:#1a1a2e}

/* â”€â”€ ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ â”€â”€ */
.btn-copy{background:rgba(255,255,255,.18);border:none;border-radius:4px;padding:2px 7px;font-size:11px;cursor:pointer;color:rgba(255,255,255,.85);margin-left:auto;transition:background .15s;flex-shrink:0}
.btn-copy:hover{background:rgba(255,255,255,.35)}

/* â”€â”€ å‚è€ƒè³‡æ–™æŠ˜ã‚Šç•³ã¿ â”€â”€ */
.context-wrap.collapsed #context,.context-wrap.collapsed .context-hint{display:none}
.context-toggle-btn{background:none;border:none;cursor:pointer;font-size:13px;color:#666;padding:0;display:flex;align-items:center;gap:4px;transition:color .15s}
.context-toggle-btn:hover{color:#333}
.context-arrow{display:inline-block;transition:transform .2s;font-style:normal}
.context-wrap.collapsed .context-arrow{transform:rotate(-90deg)}

/* â”€â”€ ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.facilitate-wrap{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.facilitate-header{background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;padding:14px 20px;font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
.facilitate-score-area{display:flex;align-items:center;gap:20px;padding:16px 20px;border-bottom:1px solid #f0f2f5;background:#fffbf5}
.score-circle{width:72px;height:72px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;transition:background .5s;background:#ccc}
.score-circle .sv{font-size:24px;line-height:1}
.score-circle small{font-size:11px;font-weight:400}
.score-circle.low{background:#e74c3c}.score-circle.mid{background:#f39c12}.score-circle.high{background:#27ae60}
.score-info{flex:1}
.score-label{font-size:13px;font-weight:600;color:#555;margin-bottom:7px}
.score-meter{height:10px;background:#f0f2f5;border-radius:5px;overflow:hidden;margin-bottom:5px}
.score-meter-fill{height:100%;border-radius:5px;width:0%;transition:width .9s cubic-bezier(.4,0,.2,1)}
.score-meter-fill.low{background:#e74c3c}.score-meter-fill.mid{background:#f39c12}.score-meter-fill.high{background:#27ae60}
.extend-badge{display:none;background:#e74c3c;color:#fff;font-size:11px;padding:3px 10px;border-radius:10px;margin-top:4px}
.facilitate-body{padding:16px 20px;font-size:13.5px;line-height:1.8;color:#333;max-height:400px;overflow-y:auto}
.facilitate-body h2{font-size:14px;font-weight:700;margin:12px 0 6px;color:#1a1a2e;border-bottom:2px solid #f0f2f5;padding-bottom:4px}
.facilitate-body p{margin-bottom:7px}.facilitate-body ul,.facilitate-body ol{margin:4px 0 7px 16px}.facilitate-body li{margin-bottom:2px}
.facilitate-footer{display:none;padding:12px 20px;background:#f8f9fa;border-top:1px solid #eee;align-items:center;gap:12px;flex-wrap:wrap}
.btn-proceed{background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;border:none;border-radius:8px;padding:10px 24px;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .15s}
.btn-proceed:hover:not(:disabled){opacity:.88}.btn-proceed:disabled{opacity:.5;cursor:not-allowed}
.extend-note{font-size:12px;color:#e74c3c;font-weight:600}

/* â”€â”€ æ¥ç¶šãƒ†ã‚¹ãƒˆã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ â”€â”€ */
.btn-test-copy{background:rgba(255,255,255,.22);border:none;border-radius:4px;padding:3px 10px;font-size:11px;cursor:pointer;color:rgba(255,255,255,.85);transition:background .15s;white-space:nowrap}
.btn-test-copy:hover{background:rgba(255,255,255,.38)}

/* â”€â”€ ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal-box{background:#fff;border-radius:14px;padding:26px;max-width:560px;width:92%;box-shadow:0 8px 40px rgba(0,0,0,.3);animation:fadeUp .2s ease}
.modal-title{font-size:16px;font-weight:700;margin-bottom:14px;color:#1a1a2e;display:flex;align-items:center;gap:8px}
.modal-body{background:#f8f9fa;border-radius:8px;padding:13px;font-size:12.5px;font-family:monospace;color:#333;max-height:220px;overflow-y:auto;margin-bottom:18px;white-space:pre-wrap;word-break:break-all;border:1px solid #e8eaed}
.modal-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.modal-btn-copy{background:#f0f2f5;border:1px solid #ddd;border-radius:6px;padding:8px 14px;font-size:13px;cursor:pointer;color:#444;transition:background .15s;margin-right:auto}
.modal-btn-copy:hover{background:#e4e6e9}
.modal-btn-continue{background:linear-gradient(135deg,#4285f4,#0f3460);color:#fff;border:none;border-radius:8px;padding:9px 20px;font-size:13px;font-weight:700;cursor:pointer;transition:opacity .15s}
.modal-btn-continue:hover{opacity:.88}
.modal-btn-reset{background:#fff;border:2px solid #dc3545;color:#dc3545;border-radius:8px;padding:9px 20px;font-size:13px;font-weight:700;cursor:pointer;transition:background .15s,color .15s}
.modal-btn-reset:hover{background:#dc3545;color:#fff}

/* â”€â”€ ãƒ­ã‚°ãƒœã‚¿ãƒ³ â”€â”€ */
.btn-log{background:rgba(255,255,255,.92);color:#1a1a2e;border:none;border-radius:8px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap}
.btn-log:hover{background:#fff}
/* â”€â”€ ãƒ­ã‚°ãƒ‘ãƒãƒ« â”€â”€ */
.log-panel{position:fixed;bottom:0;left:0;right:0;height:210px;background:#0d1117;color:#c9d1d9;z-index:800;transform:translateY(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;font-family:'Consolas','Courier New',monospace;font-size:12px;box-shadow:0 -4px 24px rgba(0,0,0,.5)}
.log-panel.show{transform:translateY(0)}
.log-panel-head{display:flex;align-items:center;gap:10px;padding:5px 14px;background:#161b22;flex-shrink:0;border-bottom:1px solid #30363d}
.log-panel-title{font-size:12px;font-weight:700;color:#e6edf3}
.log-panel-acts{margin-left:auto;display:flex;gap:5px}
.log-panel-btn{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.65);border-radius:4px;padding:3px 9px;font-size:11px;cursor:pointer;transition:background .15s}
.log-panel-btn:hover{background:rgba(255,255,255,.22);color:#fff}
.log-body{flex:1;overflow-y:auto;padding:5px 14px;line-height:1.65}
.log-line{padding:1px 0;white-space:pre-wrap;word-break:break-all}
.log-line.INFO{color:#7ee787}.log-line.ERROR{color:#f97583;font-weight:700}
.log-line.WARN{color:#e3b341}.log-line.RUN{color:#79c0ff;border-top:1px solid #21262d;margin-top:3px;padding-top:3px}

/* â”€â”€ å±¥æ­´ãƒœã‚¿ãƒ³ â”€â”€ */
.btn-hist{background:rgba(255,255,255,.92);color:#1a1a2e;border:none;border-radius:8px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap;position:relative}
.btn-hist:hover{background:#fff}
.hist-badge{position:absolute;top:-5px;right:-5px;background:#e74c3c;color:#fff;border-radius:10px;font-size:10px;padding:1px 5px;font-weight:700;min-width:16px;text-align:center;display:none}

/* â”€â”€ å±¥æ­´ãƒ‘ãƒãƒ« â”€â”€ */
.hist-overlay{display:none;position:fixed;inset:0;z-index:890;background:rgba(0,0,0,.28)}
.hist-overlay.show{display:block}
.hist-panel{position:fixed;top:0;right:-340px;width:310px;height:100vh;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,.18);z-index:900;transition:right .28s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden}
.hist-panel.show{right:0}
.hist-panel-head{background:linear-gradient(135deg,#1a1a2e,#0f3460);color:#fff;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.hist-panel-title{font-size:14px;font-weight:700}
.hist-count-label{font-size:11px;color:rgba(255,255,255,.55);margin-top:2px}
.hist-close-btn{background:none;border:none;color:rgba(255,255,255,.65);cursor:pointer;font-size:16px;padding:4px 7px;border-radius:4px;transition:background .15s}
.hist-close-btn:hover{background:rgba(255,255,255,.15);color:#fff}
.hist-list{flex:1;overflow-y:auto;padding:8px}
.hist-empty{padding:28px 16px;text-align:center;color:#aaa;font-size:13px;line-height:1.8}
.hist-section-label{font-size:10px;font-weight:700;color:#aaa;letter-spacing:.5px;padding:8px 4px 3px;border-bottom:1px solid #f0f2f5;margin-bottom:5px;text-transform:uppercase}
.hist-item{background:#f8f9fa;border-radius:8px;padding:9px 10px;margin-bottom:6px;cursor:pointer;border:2px solid transparent;transition:all .15s;user-select:none}
.hist-item:hover{background:#eef0f3;border-color:#ddd}
.hist-item.pinned{border-color:#f39c12;background:#fffbf0}
.hist-item-top{display:flex;align-items:center;gap:4px;margin-bottom:3px}
.hist-date{font-size:11px;color:#888;flex:1}
.hist-score-sm{font-size:10px;color:#fff;padding:1px 5px;border-radius:8px;font-weight:700}
.hist-score-sm.high{background:#27ae60}.hist-score-sm.mid{background:#f39c12}.hist-score-sm.low{background:#e74c3c}
.hist-act-row{display:flex;gap:2px}
.hist-btn{background:none;border:none;cursor:pointer;font-size:12px;padding:2px 5px;border-radius:3px;line-height:1;opacity:.55;transition:opacity .15s,background .15s}
.hist-btn:hover{opacity:1;background:rgba(0,0,0,.07)}
.hist-preview{font-size:12px;color:#444;line-height:1.45;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-all}

/* â”€â”€ å±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.hist-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);z-index:1100;align-items:center;justify-content:center}
.hist-modal-overlay.show{display:flex}
.hist-modal{background:#fff;border-radius:14px;width:min(940px,96vw);max-height:88vh;display:flex;flex-direction:column;box-shadow:0 12px 50px rgba(0,0,0,.35);animation:fadeUp .2s ease}
.hist-modal-head{background:linear-gradient(135deg,#1a1a2e,#0f3460);color:#fff;padding:16px 20px;border-radius:14px 14px 0 0;flex-shrink:0}
.hist-modal-meta{display:flex;align-items:center;gap:10px;font-size:12px;color:rgba(255,255,255,.6);margin-bottom:7px}
.hist-modal-score-badge{color:#fff;font-size:11px;padding:2px 9px;border-radius:10px;font-weight:700}
.hist-modal-q{font-size:14px;font-weight:600;color:#fff;line-height:1.6}
.hist-tabs{display:flex;background:#f8f9fa;border-bottom:1px solid #e8eaed;flex-shrink:0;overflow-x:auto}
.hist-tab-btn{background:none;border:none;padding:10px 18px;font-size:13px;cursor:pointer;color:#888;border-bottom:3px solid transparent;transition:all .15s;white-space:nowrap;flex-shrink:0}
.hist-tab-btn.active{color:#1a1a2e;border-bottom-color:#4285f4;font-weight:700;background:#fff}
.hist-tab-btn:hover:not(.active){color:#555;background:#eef0f3}
.hist-modal-body{padding:20px;flex:1;overflow-y:auto;font-size:13.5px;line-height:1.85;color:#333}
.hist-modal-body h1,.hist-modal-body h2{font-size:15px;font-weight:700;margin:14px 0 7px;color:#1a1a2e;border-bottom:2px solid #f0f2f5;padding-bottom:4px}
.hist-modal-body h3{font-size:13px;font-weight:700;margin:10px 0 4px;color:#444}
.hist-modal-body p{margin-bottom:8px}
.hist-modal-body ul,.hist-modal-body ol{margin:4px 0 8px 18px}
.hist-modal-body li{margin-bottom:3px}
.hist-modal-body strong{color:#1a1a2e}
.hist-modal-body hr{border:none;border-top:2px solid #f0f2f5;margin:16px 0}
.hist-modal-footer{padding:12px 20px;background:#f8f9fa;border-top:1px solid #eee;display:flex;align-items:center;gap:10px;border-radius:0 0 14px 14px;flex-shrink:0}
.hist-modal-close-btn{background:#fff;border:2px solid #ddd;color:#555;border-radius:8px;padding:8px 16px;font-size:13px;cursor:pointer;transition:all .15s;margin-left:auto}
.hist-modal-close-btn:hover{border-color:#999;color:#333}
</style>
</head>
<body>

<header>
  <div style="flex:1;min-width:0">
    <h1>ğŸ¤– AI ãƒˆãƒªã‚ªå”è­°ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>ChatGPT Ã— Gemini Ã— Claude ãŒå”è­°ã—ã¦ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã‚’å°ãå‡ºã—ã¾ã™</p>
    <div id="test-result-bar" style="display:none;margin-top:8px;gap:16px;flex-wrap:wrap;align-items:center;font-size:12px;color:rgba(255,255,255,.85)"></div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button class="btn-test" id="btn-test" onclick="testConnection()">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button class="btn-log"  id="btn-log"  onclick="toggleLogPanel()">ğŸ” ãƒ­ã‚°</button>
    <button class="btn-hist" id="btn-hist" onclick="toggleHistoryPanel()">ğŸ“‹ å±¥æ­´<span class="hist-badge" id="hist-badge"></span></button>
    <button class="btn-shutdown" onclick="shutdownServer()">ğŸ”´ ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢</button>
  </div>
</header>

<main>

  <!-- å…¥åŠ› -->
  <div class="input-card">
    <textarea id="question" placeholder="è³ªå•ãƒ»èª¿æŸ»å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦&#10;ä¾‹ï¼šã€Œæ—¥æœ¬ã®å°‘å­åŒ–å•é¡Œã®æ ¹æœ¬åŸå› ã¨åŠ¹æœçš„ãªå¯¾ç­–ã¯ï¼Ÿã€&#10;&#10;Shift+Enter ã§æ”¹è¡Œã€Enter ã§é€ä¿¡"></textarea>

    <!-- å‚è€ƒè³‡æ–™æ¬„ -->
    <div class="context-wrap collapsed" id="context-wrap">
      <div class="context-toggle">
        <span class="context-label">
          <button class="context-toggle-btn" onclick="toggleContext()">
            <i class="context-arrow">â–¼</i> ğŸ“ å‚è€ƒè³‡æ–™ï¼ˆä»»æ„ï¼‰
          </button>
        </span>
        <button class="btn-load-self" id="btn-load-self" onclick="loadSelf()">ğŸ”„ ã“ã®ã‚·ã‚¹ãƒ†ãƒ è‡ªèº«ã‚’èª­ã¿è¾¼ã‚€</button>
      </div>
      <div class="context-hint">ã“ã“ã«è²¼ã£ãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ãƒ»ä»•æ§˜ãƒ»è³‡æ–™ãªã©ï¼‰ãŒ3è€…å…¨å“¡ã«æ¸¡ã•ã‚Œã¾ã™</div>
      <textarea id="context" placeholder="å‚è€ƒè³‡æ–™ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘â€¦ï¼ˆç©ºæ¬„ã§ã‚‚OKï¼‰"></textarea>
    </div>

    <div class="input-footer">
      <span class="hint">3 AI Ã— 3ã‚¹ãƒ†ãƒƒãƒ—ã§å”è­° ï¼ 1å›ã‚ãŸã‚Šç´„ $0.02ã€œ0.10</span>
      <button class="btn-start" id="btn-start" onclick="startDiscussion()">ğŸš€ å”è­°é–‹å§‹</button>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ -->
  <div class="progress-wrap" id="progress-wrap">
    <div class="prog-step" id="prog1">
      <div class="prog-circle">1</div>
      <div class="prog-label">åˆå›å›ç­”</div>
    </div>
    <div class="prog-line" id="pline1"></div>
    <div class="prog-step" id="progF">
      <div class="prog-circle">F</div>
      <div class="prog-label">ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼</div>
    </div>
    <div class="prog-line" id="plineF"></div>
    <div class="prog-step" id="prog2">
      <div class="prog-circle">2</div>
      <div class="prog-label">ç›¸äº’ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
    </div>
    <div class="prog-line" id="pline2"></div>
    <div class="prog-step" id="prog3">
      <div class="prog-circle">3</div>
      <div class="prog-label">æœ€çµ‚çµ±åˆ</div>
    </div>
  </div>

  <!-- STEP 1 -->
  <div class="step-section" id="sec1">
    <div class="step-header">
      <div class="step-badge">STEP 1</div>
      <div class="step-title">å„AIã®åˆå›å›ç­”</div>
    </div>
    <div class="ai-grid">
      <div class="ai-card chatgpt">
        <div class="ai-card-header">
          <div class="ai-icon">ğŸ’¬</div>ChatGPT
          <span class="model-label" id="model-chatgpt"></span>
          <button class="btn-copy" onclick="copyCard('s1-chatgpt')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
        </div>
        <div class="ai-card-body loading" id="s1-chatgpt"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat1-chatgpt" style="display:none">
          <span>ğŸ“ <b id="c1-chatgpt">-</b> å­—</span>
          <span>â“ <b id="q1-chatgpt">-</b> è³ªå•</span>
        </div>
      </div>
      <div class="ai-card gemini">
        <div class="ai-card-header">
          <div class="ai-icon">âœ¨</div>Gemini
          <button class="btn-copy" onclick="copyCard('s1-gemini')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
        </div>
        <div class="ai-card-body loading" id="s1-gemini"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat1-gemini" style="display:none">
          <span>ğŸ“ <b id="c1-gemini">-</b> å­—</span>
          <span>â“ <b id="q1-gemini">-</b> è³ªå•</span>
        </div>
      </div>
      <div class="ai-card claude">
        <div class="ai-card-header">
          <div class="ai-icon">ğŸ§ </div>Claude
          <button class="btn-copy" onclick="copyCard('s1-claude')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
        </div>
        <div class="ai-card-body loading" id="s1-claude"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat1-claude" style="display:none">
          <span>ğŸ“ <b id="c1-claude">-</b> å­—</span>
          <span>â“ <b id="q1-claude">-</b> è³ªå•</span>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP F ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ -->
  <div class="step-section" id="secF">
    <div class="step-header">
      <div class="step-badge" style="background:#e67e22">STEP F</div>
      <div class="step-title">ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼åˆ†æ</div>
    </div>
    <div class="facilitate-wrap">
      <div class="facilitate-header">
        ğŸ¯ ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ï¼ˆGPT-4oï¼‰ã«ã‚ˆã‚‹ä¸­é–“åˆ†æ
        <button class="btn-copy" style="margin-left:auto" onclick="copyCard('facilitate-body')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
      </div>
      <div class="facilitate-score-area">
        <div class="score-circle" id="score-circle">
          <span class="sv" id="score-value">â€¦</span>
          <small>ç‚¹</small>
        </div>
        <div class="score-info">
          <div class="score-label" id="score-label">åˆ†æä¸­â€¦</div>
          <div class="score-meter"><div class="score-meter-fill" id="score-meter-fill"></div></div>
          <span class="extend-badge" id="extend-badge">âš ï¸ å®Œæˆåº¦70ç‚¹æœªæº€ â€” Step2ã§ã®å¤§å¹…æ”¹å–„ã‚’æ¨å¥¨</span>
        </div>
      </div>
      <div class="facilitate-body" id="facilitate-body">
        <div class="ai-card-body loading"><div class="spinner"></div>ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼åˆ†æä¸­â€¦</div>
      </div>
      <div class="facilitate-footer" id="facilitate-footer">
        <button class="btn-proceed" id="btn-proceed" onclick="proceedToStep2()">â†’ Step 2ï¼ˆç›¸äº’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã¸é€²ã‚€</button>
        <span class="extend-note" id="extend-note" style="display:none">âš ï¸ ä½ã‚¹ã‚³ã‚¢ã®ãŸã‚ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼æŒ‡æ‘˜äº‹é …ã‚’Step2ã«å¼•ãç¶™ãã¾ã™</span>
      </div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="step-section" id="sec2">
    <div class="step-header">
      <div class="step-badge">STEP 2</div>
      <div class="step-title">ç›¸äº’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä»–ã®AIã®å›ç­”ã‚’èª­ã‚“ã§è¿½è¨˜ãƒ»ä¿®æ­£ï¼‰</div>
    </div>
    <div class="ai-grid">
      <div class="ai-card chatgpt">
        <div class="ai-card-header"><div class="ai-icon">ğŸ’¬</div>ChatGPT ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼<button class="btn-copy" onclick="copyCard('s2-chatgpt')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
        <div class="ai-card-body loading" id="s2-chatgpt"><div class="spinner"></div>ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat2-chatgpt" style="display:none">
          <span>ğŸ“ <b id="c2-chatgpt">-</b> å­—</span>
          <span>â“ <b id="q2-chatgpt">-</b> è³ªå•</span>
        </div>
      </div>
      <div class="ai-card gemini">
        <div class="ai-card-header"><div class="ai-icon">âœ¨</div>Gemini ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼<button class="btn-copy" onclick="copyCard('s2-gemini')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
        <div class="ai-card-body loading" id="s2-gemini"><div class="spinner"></div>ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat2-gemini" style="display:none">
          <span>ğŸ“ <b id="c2-gemini">-</b> å­—</span>
          <span>â“ <b id="q2-gemini">-</b> è³ªå•</span>
        </div>
      </div>
      <div class="ai-card claude">
        <div class="ai-card-header"><div class="ai-icon">ğŸ§ </div>Claude ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼<button class="btn-copy" onclick="copyCard('s2-claude')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
        <div class="ai-card-body loading" id="s2-claude"><div class="spinner"></div>ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­â€¦</div>
        <div class="ai-stats" id="stat2-claude" style="display:none">
          <span>ğŸ“ <b id="c2-claude">-</b> å­—</span>
          <span>â“ <b id="q2-claude">-</b> è³ªå•</span>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="step-section" id="sec3">
    <div class="step-header">
      <div class="step-badge">STEP 3</div>
      <div class="step-title">æœ€çµ‚çµ±åˆå›ç­” &amp; è²¢çŒ®åº¦åˆ†æ</div>
    </div>

    <!-- è²¢çŒ®åº¦ãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="contrib-card" id="contrib-card" style="display:none">
      <div class="contrib-title">ğŸ“Š è²¢çŒ®åº¦æ¯”è¼ƒï¼ˆæ–‡å­—æ•°ãƒ»è³ªå•æ•°ãƒ™ãƒ¼ã‚¹ï¼‰</div>
      <div class="contrib-row">
        <div class="contrib-label">ğŸ’¬ ChatGPT</div>
        <div class="contrib-bar-wrap"><div class="contrib-bar chatgpt" id="bar-chatgpt" style="width:0%">-</div></div>
        <div class="contrib-meta" id="meta-chatgpt">-</div>
      </div>
      <div class="contrib-row">
        <div class="contrib-label">âœ¨ Gemini</div>
        <div class="contrib-bar-wrap"><div class="contrib-bar gemini" id="bar-gemini" style="width:0%">-</div></div>
        <div class="contrib-meta" id="meta-gemini">-</div>
      </div>
      <div class="contrib-row">
        <div class="contrib-label">ğŸ§  Claude</div>
        <div class="contrib-bar-wrap"><div class="contrib-bar claude" id="bar-claude" style="width:0%">-</div></div>
        <div class="contrib-meta" id="meta-claude">-</div>
      </div>
    </div>

    <!-- æœ€çµ‚å›ç­” -->
    <div class="final-card">
      <div class="final-card-header">
        ğŸ† æœ€çµ‚çµ±åˆå›ç­”ï¼ˆGPT-4o ã«ã‚ˆã‚‹çµ±åˆï¼‰
        <button class="btn-copy" style="background:rgba(255,255,255,.18);border:none;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;color:rgba(255,255,255,.85);margin-left:auto;transition:background .15s" onclick="copyCard('final-body')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
      </div>
      <div class="final-card-body" id="final-body">
        <div style="display:flex;align-items:center;gap:12px;color:#aaa;justify-content:center;padding:40px">
          <div class="spinner"></div>çµ±åˆå›ç­”ã‚’ç”Ÿæˆä¸­â€¦
        </div>
      </div>
    </div>
  </div>

  <!-- è¿½åŠ è³ªå• -->
  <div class="step-section" id="sec-followup">
    <div class="step-header">
      <div class="step-badge" style="background:#16a085">è¿½åŠ è³ªå•</div>
      <div class="step-title">çµè«–ã«å¯¾ã—ã¦è¿½åŠ ã§è³ªå•ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
    </div>
    <div class="input-card">
      <textarea id="followup-question" placeholder="è¿½åŠ ã®è³ªå•ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¥åŠ›â€¦&#10;ä¾‹ï¼šã€Œã‚‚ã£ã¨å…·ä½“çš„ãªå®Ÿæ–½æ‰‹é †ã‚’æ•™ãˆã¦ã€ã€Œã‚³ã‚¹ãƒˆé¢ã§ã®æ¯”è¼ƒã‚’ã—ã¦ã€" style="min-height:70px"></textarea>
      <div class="input-footer">
        <span class="hint">å‰å›ã®å…¨å›ç­”ãŒæ–‡è„ˆã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™</span>
        <button class="btn-start" id="btn-followup" onclick="startFollowup()" style="background:linear-gradient(135deg,#16a085,#1abc9c)">ğŸ’¬ è¿½åŠ è³ªå•ã‚’é€ã‚‹</button>
      </div>
    </div>
    <!-- è¿½åŠ è³ªå•ã®å›ç­” -->
    <div id="followup-results" style="display:none;margin-top:16px">
      <div class="ai-grid">
        <div class="ai-card chatgpt">
          <div class="ai-card-header"><div class="ai-icon">ğŸ’¬</div>ChatGPT<button class="btn-copy" onclick="copyCard('fq-chatgpt')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
          <div class="ai-card-body loading" id="fq-chatgpt"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        </div>
        <div class="ai-card gemini">
          <div class="ai-card-header"><div class="ai-icon">âœ¨</div>Gemini<button class="btn-copy" onclick="copyCard('fq-gemini')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
          <div class="ai-card-body loading" id="fq-gemini"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        </div>
        <div class="ai-card claude">
          <div class="ai-card-header"><div class="ai-icon">ğŸ§ </div>Claude<button class="btn-copy" onclick="copyCard('fq-claude')" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button></div>
          <div class="ai-card-body loading" id="fq-claude"><div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦</div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ãƒ‘ãƒãƒ« -->
<div class="log-panel" id="log-panel">
  <div class="log-panel-head">
    <span class="log-panel-title">ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ï¼ˆç›´è¿‘2å›åˆ†ï¼‰</span>
    <div class="log-panel-acts">
      <button class="log-panel-btn" onclick="fetchLogs()">ğŸ”„ æ›´æ–°</button>
      <button class="log-panel-btn" onclick="clearLog()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
      <button class="log-panel-btn" onclick="toggleLogPanel()">âœ•</button>
    </div>
  </div>
  <div class="log-body" id="log-body"><span style="color:rgba(255,255,255,.3)">ãƒ­ã‚°ãªã—</span></div>
</div>

<!-- å±¥æ­´ãƒ‘ãƒãƒ«èƒŒæ™¯ -->
<div class="hist-overlay" id="hist-overlay" onclick="toggleHistoryPanel()"></div>

<!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
<div class="hist-panel" id="history-panel">
  <div class="hist-panel-head">
    <div>
      <div class="hist-panel-title">ğŸ“‹ å”è­°å±¥æ­´</div>
      <div class="hist-count-label" id="hist-count-label"></div>
    </div>
    <button class="hist-close-btn" onclick="toggleHistoryPanel()">âœ•</button>
  </div>
  <div class="hist-list" id="history-list">
    <div class="hist-empty">ğŸ“­ å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“<br><small>Step 3 å®Œäº†å¾Œã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</small></div>
  </div>
</div>

<!-- ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="error-modal">
  <div class="modal-box">
    <div class="modal-title">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
    <div class="modal-body" id="error-modal-body"></div>
    <div class="modal-actions">
      <button class="modal-btn-copy" onclick="copyModalError()">ğŸ“‹ ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="modal-btn-reset" onclick="resolveErrorModal(false)">âœ• æœ€åˆã«æˆ»ã‚‹</button>
      <button class="modal-btn-continue" onclick="resolveErrorModal(true)">â†’ ã“ã®ã¾ã¾ç¶šè¡Œ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
<script>
marked.use({ breaks: true, gfm: true });

const $  = id => document.getElementById(id);
const AIs = ['chatgpt', 'gemini', 'claude'];

let s1Data = null, s2Data = null, fData = null, s3Result = null;

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function countChars(t)     { return (t || '').length; }
function countQuestions(t) { return ((t || '').match(/[ï¼Ÿ?]|ã€è³ªå•ã€‘/g) || []).length; }

function setProgress(step) {
  // step: 1=åˆå›, 2=ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼, 3=ç›¸äº’ãƒ¬ãƒ“ãƒ¥ãƒ¼, 4=æœ€çµ‚çµ±åˆ
  const ids    = ['1','F','2','3'];
  const labels = ['1','F','2','3'];
  const lineIds = ['1','F','2'];
  ids.forEach((id, i) => {
    const pos = i + 1;
    const el  = $('prog' + id);
    if (!el) return;
    if (pos < step) {
      el.className = 'prog-step done';
      el.querySelector('.prog-circle').textContent = 'âœ“';
    } else if (pos === step) {
      el.className = 'prog-step active';
    } else {
      el.className = 'prog-step';
      el.querySelector('.prog-circle').textContent = labels[i];
    }
  });
  lineIds.forEach((id, i) => {
    const el = $('pline' + id);
    if (el) el.className = (i + 1) < step ? 'prog-line done' : 'prog-line';
  });
}

function renderCard(bodyId, statId, cId, qId, text) {
  const el = $(bodyId);
  el.className = 'ai-card-body';
  el.innerHTML = marked.parse(text || 'âš ï¸ å–å¾—å¤±æ•—');
  $(cId).textContent = countChars(text).toLocaleString();
  $(qId).textContent = countQuestions(text);
  $(statId).style.display = 'flex';
}

function renderContrib(s1, s2) {
  const scores = {}, qs = {};
  AIs.forEach(n => {
    scores[n] = countChars(s1[n]) + countChars(s2[n]);
    qs[n]     = countQuestions(s1[n]) + countQuestions(s2[n]);
  });
  const total = Object.values(scores).reduce((a,b)=>a+b,0) || 1;
  $('contrib-card').style.display = 'block';
  AIs.forEach(n => {
    const pct = Math.round(scores[n]/total*100);
    const bar = $('bar-'+n);
    bar.textContent = pct+'%';
    setTimeout(() => bar.style.width = pct+'%', 50);
    $('meta-'+n).textContent = `ç·å­—æ•° ${scores[n].toLocaleString()} ï¼ è³ªå• ${qs[n]}ä»¶`;
  });
}

async function post(url, data) {
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  if (!r.ok) throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: HTTP ${r.status}`);
  return r.json();
}

function scrollTo(id) {
  setTimeout(() => $(id).scrollIntoView({ behavior:'smooth', block:'start' }), 80);
}

function resetCards() {
  AIs.forEach(n => {
    ['s1-','s2-'].forEach(p => {
      const el = $(p+n);
      if (el) { el.className='ai-card-body loading'; el.innerHTML='<div class="spinner"></div>ç”Ÿæˆä¸­â€¦'; }
      const st = $('stat'+(p==='s1-'?1:2)+'-'+n);
      if (st) st.style.display='none';
    });
  });
  $('contrib-card').style.display = 'none';
  $('final-body').innerHTML = '<div style="display:flex;align-items:center;gap:12px;color:#aaa;justify-content:center;padding:40px"><div class="spinner"></div>çµ±åˆå›ç­”ã‚’ç”Ÿæˆä¸­â€¦</div>';
  ['sec1','secF','sec2','sec3','sec-followup'].forEach(id => { const el = $(id); if(el) el.classList.remove('show'); });
  // ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
  const fb = $('facilitate-body');
  if (fb) fb.innerHTML = '<div class="ai-card-body loading"><div class="spinner"></div>ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼åˆ†æä¸­â€¦</div>';
  const ff = $('facilitate-footer'); if (ff) ff.style.display = 'none';
  const sc = $('score-circle');     if (sc) sc.className = 'score-circle';
  const sv = $('score-value');      if (sv) sv.textContent = 'â€¦';
  const mf = $('score-meter-fill'); if (mf) { mf.className = 'score-meter-fill'; mf.style.width = '0%'; }
  const eb = $('extend-badge');     if (eb) eb.style.display = 'none';
  const sl = $('score-label');      if (sl) sl.textContent = 'åˆ†æä¸­â€¦';
  const en = $('extend-note');      if (en) en.style.display = 'none';
  const bp = $('btn-proceed');      if (bp) bp.disabled = false;
  // è¿½åŠ è³ªå•ãƒªã‚»ãƒƒãƒˆ
  const fr = $('followup-results'); if (fr) fr.style.display = 'none';
  const fq = $('followup-question'); if (fq) fq.value = '';
  AIs.forEach(n => {
    const el = $('fq-'+n);
    if (el) { el.className='ai-card-body loading'; el.innerHTML='<div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦'; }
  });
  fData = null; s3Result = null;
}

// â”€â”€ æ¥ç¶šãƒ†ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTestErrors = '';

async function testConnection() {
  const btn = $('btn-test');
  const bar = $('test-result-bar');
  btn.disabled = true;
  btn.textContent = 'ğŸ”Œ ãƒ†ã‚¹ãƒˆä¸­â€¦';
  lastTestErrors = '';

  const aiNames = { chatgpt: 'ChatGPT', gemini: 'Gemini', claude: 'Claude' };
  bar.style.display = 'flex';
  bar.innerHTML = ['chatgpt','gemini','claude'].map(n =>
    `<span class="test-item"><span class="test-dot wait"></span>${aiNames[n]}: ç¢ºèªä¸­â€¦</span>`
  ).join('');

  try {
    const res = await fetch('/api/test-connection').then(r => r.json());
    const errors = [];
    const items = Object.entries(res).map(([n, r]) => {
      const cls    = r.ok ? 'ok' : 'ng';
      const icon   = r.ok ? 'âœ…' : 'âŒ';
      const detail = r.ok ? (r.model || '') : (r.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
      if (!r.ok) errors.push(`${aiNames[n]||n}: ${detail}`);
      return `<span class="test-item"><span class="test-dot ${cls}"></span>${icon} ${aiNames[n]||n}: ${r.ok ? r.model : detail.substring(0,80)}</span>`;
    }).join('');
    bar.innerHTML = items;
    if (errors.length > 0) {
      lastTestErrors = errors.join('\n');
      bar.innerHTML += `<button class="btn-test-copy" onclick="copyTestErrors(this)">ğŸ“‹ ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</button>`;
    }
  } catch(e) {
    lastTestErrors = `ãƒ†ã‚¹ãƒˆå¤±æ•—: ${e.message}`;
    bar.innerHTML = `<span>âš ï¸ ${lastTestErrors}</span><button class="btn-test-copy" onclick="copyTestErrors(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ';
  }
}

function copyTestErrors(btn) {
  navigator.clipboard.writeText(lastTestErrors).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = lastTestErrors;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    const orig = btn.textContent;
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  });
}

// â”€â”€ ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let errorModalResolve = null;

function showErrorModal(message) {
  return new Promise(resolve => {
    errorModalResolve = resolve;
    $('error-modal-body').textContent = message;
    $('error-modal').classList.add('show');
  });
}
function resolveErrorModal(proceed) {
  $('error-modal').classList.remove('show');
  if (errorModalResolve) { errorModalResolve(proceed); errorModalResolve = null; }
}
function copyModalError() {
  const text = $('error-modal-body').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.modal-btn-copy');
    const orig = btn.textContent;
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  });
}

// â”€â”€ å‚è€ƒè³‡æ–™æŠ˜ã‚Šç•³ã¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleContext() {
  $('context-wrap').classList.toggle('collapsed');
}

// â”€â”€ ã‚³ãƒ”ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyCard(bodyId) {
  const el = $(bodyId);
  if (!el) return;
  const text = el.innerText || el.textContent || '';
  navigator.clipboard.writeText(text).then(() => {
    const card = el.closest('.ai-card, .facilitate-wrap, .final-card');
    const btn  = card && card.querySelector('.btn-copy');
    if (btn) { const orig = btn.textContent; btn.textContent = 'âœ…'; setTimeout(() => { btn.textContent = orig; }, 1500); }
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = el.innerText || '';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  });
}

// â”€â”€ ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFacilitator(fd) {
  const score = fd.score || 0;
  const cls   = score >= 70 ? 'high' : score >= 50 ? 'mid' : 'low';
  const lbl   = score >= 70 ? 'ååˆ†ãªå“è³ªã§ã™' : score >= 50 ? 'æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™' : 'å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™';
  const sc = $('score-circle');
  if (sc) sc.className = 'score-circle ' + cls;
  const sv = $('score-value');      if (sv) sv.textContent = score;
  const sl = $('score-label');      if (sl) sl.textContent = `å®Œæˆåº¦ ${score}ç‚¹ â”€ ${lbl}`;
  const mf = $('score-meter-fill');
  if (mf) { mf.className = 'score-meter-fill ' + cls; setTimeout(() => { mf.style.width = score + '%'; }, 50); }
  const eb = $('extend-badge'); if (eb) eb.style.display = fd.should_extend ? 'inline-block' : 'none';
  const en = $('extend-note');  if (en) en.style.display = fd.should_extend ? 'inline' : 'none';
  const fb = $('facilitate-body'); if (fb) fb.innerHTML = marked.parse(fd.report || 'âš ï¸ åˆ†æå¤±æ•—');
}

// â”€â”€ ã‚µãƒ¼ãƒãƒ¼åœæ­¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shutdownServer() {
  if (!confirm('ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã‚‚é–‰ã˜ã¦ãã ã•ã„ã€‚')) return;
  try {
    await fetch('/api/shutdown', { method: 'POST' });
  } catch(e) {
    // ã‚µãƒ¼ãƒãƒ¼ãŒæ­¢ã¾ã‚‹ã®ã§ fetch ã¯å¿…ãšã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ï¼ˆæ­£å¸¸ï¼‰
  }
  document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-size:18px;color:#666;font-family:sans-serif">ğŸ”´ ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</div>';
}

// â”€â”€ ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã‚€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSelf() {
  const btn = $('btn-load-self');
  btn.disabled = true;
  btn.textContent = 'â³ èª­ã¿è¾¼ã¿ä¸­â€¦';
  try {
    const data = await fetch('/api/load-self').then(r => r.json());
    const text = Object.entries(data)
      .map(([name, code]) => `=== ${name} ===\n${code}`)
      .join('\n\n');
    $('context').value = text;
    btn.textContent = 'âœ… èª­ã¿è¾¼ã¿å®Œäº†';
    setTimeout(() => { btn.textContent = 'ğŸ”„ ã“ã®ã‚·ã‚¹ãƒ†ãƒ è‡ªèº«ã‚’èª­ã¿è¾¼ã‚€'; btn.disabled = false; }, 2000);
  } catch(e) {
    alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
    btn.textContent = 'ğŸ”„ ã“ã®ã‚·ã‚¹ãƒ†ãƒ è‡ªèº«ã‚’èª­ã¿è¾¼ã‚€';
    btn.disabled = false;
  }
}

// â”€â”€ ã‚¨ãƒ©ãƒ¼æ¤œå‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectErrors(data) {
  return AIs.filter(n => data[n] && data[n].startsWith('âš ï¸ ã‚¨ãƒ©ãƒ¼:'))
             .map(n => [n, data[n].slice('âš ï¸ ã‚¨ãƒ©ãƒ¼:'.length).trim()]);
}

// â”€â”€ ãƒ¡ã‚¤ãƒ³å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startDiscussion() {
  const question = $('question').value.trim();
  if (!question) { alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const context = $('context').value.trim();

  $('btn-start').disabled = true;
  $('btn-start').textContent = 'â³ å”è­°ä¸­â€¦';
  $('progress-wrap').classList.add('show');
  resetCards();

  try {
    // â”€â”€ STEP 1 â”€â”€
    setProgress(1);
    $('sec1').classList.add('show');

    s1Data = await post('/api/step1', { question, context });
    AIs.forEach(n => renderCard(`s1-${n}`, `stat1-${n}`, `c1-${n}`, `q1-${n}`, s1Data[n]));
    await fetchLogs();

    // â”€â”€ ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼šStep2ã«é€²ã‚€å‰ã«ç¢ºèª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const errors1 = detectErrors(s1Data);
    if (errors1.length > 0) {
      const aiNames = { chatgpt: 'ChatGPT', gemini: 'Gemini', claude: 'Claude' };
      const errMsgs = errors1.map(([n, msg]) => `ãƒ»${aiNames[n]}: ${msg}`).join('\n');
      const message = `${errors1.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n${errMsgs}\n\nã“ã®ã¾ã¾Step Fï¼ˆãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ï¼‰ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ`;
      const proceed = await showErrorModal(message);
      if (!proceed) {
        resetCards();
        $('progress-wrap').classList.remove('show');
        return;
      }
    }

    // â”€â”€ STEP F â”€â”€ ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼
    setProgress(2);
    $('secF').classList.add('show');
    scrollTo('secF');

    fData = await post('/api/step2_5', { question, step1: s1Data });
    renderFacilitator(fData);
    $('facilitate-footer').style.display = 'flex';

  } catch(e) {
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + e.message);
  } finally {
    $('btn-start').disabled = false;
    $('btn-start').textContent = 'ğŸš€ å”è­°é–‹å§‹';
  }
}

// â”€â”€ Step2ãƒ»3 å®Ÿè¡Œï¼ˆãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ç¢ºèªå¾Œï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function proceedToStep2() {
  $('btn-proceed').disabled = true;
  $('btn-start').disabled = true;
  $('btn-start').textContent = 'â³ å”è­°ä¸­â€¦';
  const question = $('question').value.trim();
  const context  = $('context').value.trim();

  try {
    // â”€â”€ STEP 2 â”€â”€
    setProgress(3);
    $('sec2').classList.add('show');
    scrollTo('sec2');

    const facReport = fData ? fData.report : '';
    s2Data = await post('/api/step2', { question, context, step1: s1Data, facilitate_report: facReport });
    AIs.forEach(n => renderCard(`s2-${n}`, `stat2-${n}`, `c2-${n}`, `q2-${n}`, s2Data[n]));

    // â”€â”€ STEP 3 â”€â”€
    setProgress(4);
    $('sec3').classList.add('show');
    scrollTo('sec3');
    renderContrib(s1Data, s2Data);

    const s3 = await post('/api/step3', { question, context, step1: s1Data, step2: s2Data });
    if (s3.error) {
      // Step3 ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’UIã«è¡¨ç¤ºã—ã¦ãƒ­ã‚°ãƒ‘ãƒãƒ«ã‚’é–‹ã
      $('sec3').classList.add('show');
      $('final-body').innerHTML = `<div style="color:#c0392b;background:#fdf2f2;border:1px solid #f5c6cb;border-radius:8px;padding:16px;font-family:monospace;white-space:pre-wrap">âš ï¸ Step3 ã‚¨ãƒ©ãƒ¼\n\n${s3.error}\n\nğŸ” ãƒ­ã‚°ãƒ‘ãƒãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
      await fetchLogs();
      $('log-panel').classList.add('show');
      return;
    }
    s3Result = s3.result || '';
    $('final-body').innerHTML = marked.parse(s3Result || 'âš ï¸ å–å¾—å¤±æ•—');
    saveHistory();
    await fetchLogs();

    // è¿½åŠ è³ªå•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    $('sec-followup').classList.add('show');
    scrollTo('sec-followup');

  } catch(e) {
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + e.message);
  } finally {
    $('btn-start').disabled = false;
    $('btn-start').textContent = 'ğŸš€ å”è­°é–‹å§‹';
  }
}

// â”€â”€ è¿½åŠ è³ªå• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startFollowup() {
  const fq = $('followup-question').value.trim();
  if (!fq) { alert('è¿½åŠ è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const btn = $('btn-followup');
  btn.disabled = true;
  btn.textContent = 'â³ é€ä¿¡ä¸­â€¦';

  const question = $('question').value.trim();
  const context  = $('context').value.trim();

  // å‰å›ã®è­°è«–å…¨ä½“ã‚’æ–‡è„ˆã¨ã—ã¦æ¸¡ã™
  const prevContext = [
    `ã€å…ƒã®è³ªå•ã€‘\n${question}`,
    `ã€æœ€çµ‚çµ±åˆå›ç­”ã€‘\n${s3Result || ''}`,
    s1Data ? `ã€å„AIã®åˆå›å›ç­”ã€‘\nChatGPT: ${s1Data.chatgpt||''}\nGemini: ${s1Data.gemini||''}\nClaude: ${s1Data.claude||''}` : '',
  ].filter(Boolean).join('\n\n');

  const prompt = `ä»¥ä¸‹ã¯å‰å›ã®è­°è«–ã®æ¦‚è¦ã§ã™ã€‚\n\n${prevContext}\n\nã€è¿½åŠ è³ªå•ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘\n${fq}`;

  $('followup-results').style.display = 'block';
  AIs.forEach(n => {
    const el = $('fq-'+n);
    if (el) { el.className='ai-card-body loading'; el.innerHTML='<div class="spinner"></div>å›ç­”ç”Ÿæˆä¸­â€¦'; }
  });

  try {
    const res = await post('/api/step1', { question: prompt, context: '' });
    AIs.forEach(n => {
      const el = $('fq-'+n);
      if (el) { el.className='ai-card-body'; el.innerHTML=marked.parse(res[n]||'âš ï¸ å–å¾—å¤±æ•—'); }
    });
  } catch(e) {
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¬ è¿½åŠ è³ªå•ã‚’é€ã‚‹';
  }
}

// â”€â”€ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLogPanel() {
  const panel = $('log-panel');
  const opening = !panel.classList.contains('show');
  panel.classList.toggle('show');
  if (opening) fetchLogs();
}

async function fetchLogs() {
  try {
    const data = await fetch('/api/logs').then(r => r.json());
    renderLogs(data.entries || []);
  } catch(e) { /* ã‚µãƒ¼ãƒãƒ¼æœªèµ·å‹•æ™‚ã¯ç„¡è¦– */ }
}

function renderLogs(entries) {
  const body = $('log-body');
  if (!entries || entries.length === 0) {
    body.innerHTML = '<span style="color:rgba(255,255,255,.3)">ãƒ­ã‚°ãªã—</span>';
    return;
  }
  body.innerHTML = entries.map(e =>
    `<div class="log-line ${e.lv}">[${e.t}][${e.lv.padEnd(5)}] ${e.msg}</div>`
  ).join('');
  body.scrollTop = body.scrollHeight;
}

function clearLog() {
  $('log-body').innerHTML = '<span style="color:rgba(255,255,255,.3)">ã‚¯ãƒªã‚¢æ¸ˆã¿</span>';
}

// â”€â”€ å±¥æ­´æ©Ÿèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HIST_KEY = 'aiTrio_histories';
const HIST_MAX = 10;
// (å±¥æ­´è©³ç´°ã¯ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ç›´æ¥å¾©å…ƒã™ã‚‹ãŸã‚ãƒ¢ãƒ¼ãƒ€ãƒ«å¤‰æ•°ã¯ä¸è¦)

function loadHistories() {
  try { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); } catch { return []; }
}

function saveHistory() {
  if (!s3Result) return;
  const question = $('question').value.trim();
  if (!question) return;

  const histories = loadHistories();
  const item = {
    id:        Date.now().toString(),
    timestamp: new Date().toISOString(),
    question,
    s1Data:  s1Data  ? JSON.parse(JSON.stringify(s1Data))          : null,
    fData:   fData   ? { report: fData.report, score: fData.score } : null,
    s2Data:  s2Data  ? JSON.parse(JSON.stringify(s2Data))          : null,
    s3Result: s3Result,
    pinned:  false
  };

  histories.unshift(item);

  const pinned   = histories.filter(h => h.pinned);
  let   unpinned = histories.filter(h => !h.pinned);
  if (unpinned.length > HIST_MAX) unpinned = unpinned.slice(0, HIST_MAX);

  try {
    localStorage.setItem(HIST_KEY, JSON.stringify([...pinned, ...unpinned]));
  } catch(e) {
    console.warn('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', e);
  }
  updateHistBadge();
}

function updateHistBadge() {
  const count = loadHistories().length;
  const badge = $('hist-badge');
  if (!badge) return;
  badge.textContent   = count;
  badge.style.display = count > 0 ? 'inline-block' : 'none';
}

function toggleHistoryPanel() {
  const panel   = $('history-panel');
  const overlay = $('hist-overlay');
  const opening = !panel.classList.contains('show');
  panel.classList.toggle('show');
  overlay.classList.toggle('show');
  if (opening) renderHistoryList();
}

function renderHistoryList() {
  const histories = loadHistories();
  const list      = $('history-list');
  const countLbl  = $('hist-count-label');

  const pinCnt  = histories.filter(h => h.pinned).length;
  const autoCnt = histories.filter(h => !h.pinned).length;
  if (countLbl) countLbl.textContent = `ğŸ“Œ ${pinCnt}ä»¶  ğŸ• ${autoCnt}/${HIST_MAX}ä»¶`;

  if (histories.length === 0) {
    list.innerHTML = '<div class="hist-empty">ğŸ“­ å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“<br><small>Step 3 å®Œäº†å¾Œã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</small></div>';
    return;
  }

  const pinned   = histories.filter(h => h.pinned);
  const unpinned = histories.filter(h => !h.pinned);
  let html = '';
  if (pinned.length)   { html += '<div class="hist-section-label">ğŸ“Œ ãƒ”ãƒ³æ­¢ã‚</div>';   html += pinned.map(histItemHTML).join(''); }
  if (unpinned.length) { html += '<div class="hist-section-label">ğŸ• æœ€è¿‘ã®å±¥æ­´</div>'; html += unpinned.map(histItemHTML).join(''); }
  list.innerHTML = html;
}

function histItemHTML(item) {
  const d      = new Date(item.timestamp);
  const dStr   = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
  const prev   = item.question.substring(0, 48) + (item.question.length > 48 ? 'â€¦' : '');
  let scoreBadge = '';
  if (item.fData != null) {
    const s   = item.fData.score;
    const cls = s >= 70 ? 'high' : s >= 50 ? 'mid' : 'low';
    scoreBadge = `<span class="hist-score-sm ${cls}">${s}ç‚¹</span>`;
  }
  return `
    <div class="hist-item${item.pinned ? ' pinned' : ''}" onclick="showHistoryDetail('${item.id}')">
      <div class="hist-item-top">
        <span class="hist-date">${dStr}</span>
        ${scoreBadge}
        <div class="hist-act-row" onclick="event.stopPropagation()">
          <button class="hist-btn" onclick="togglePin('${item.id}')" title="${item.pinned ? 'ãƒ”ãƒ³è§£é™¤' : 'ãƒ”ãƒ³æ­¢ã‚'}">${item.pinned ? 'ğŸ“Œ' : 'ğŸ“'}</button>
          <button class="hist-btn" onclick="confirmDeleteHistory('${item.id}')" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      </div>
      <div class="hist-preview">${prev}</div>
    </div>`;
}

function togglePin(id) {
  const histories = loadHistories();
  const item = histories.find(h => h.id === id);
  if (!item) return;
  item.pinned = !item.pinned;
  try { localStorage.setItem(HIST_KEY, JSON.stringify(histories)); } catch(e) {}
  renderHistoryList();
  updateHistBadge();
}

function confirmDeleteHistory(id) {
  if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const histories = loadHistories().filter(h => h.id !== id);
  try { localStorage.setItem(HIST_KEY, JSON.stringify(histories)); } catch(e) {}
  renderHistoryList();
  updateHistBadge();
}

function showHistoryDetail(id) {
  const item = loadHistories().find(h => h.id === id);
  if (!item) return;

  // UI ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆresetCards å†…ã§ fData/s3Result ãŒ null ã«ãªã‚‹ã®ã§å…ˆã«å‘¼ã¶ï¼‰
  resetCards();
  $('progress-wrap').classList.add('show');

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å¾©å…ƒï¼ˆè¿½åŠ è³ªå•ã§ã‚‚ä½¿ç”¨ï¼‰
  s1Data   = item.s1Data   ? JSON.parse(JSON.stringify(item.s1Data))  : null;
  s2Data   = item.s2Data   ? JSON.parse(JSON.stringify(item.s2Data))  : null;
  fData    = item.fData    ? { report: item.fData.report, score: item.fData.score, should_extend: false } : null;
  s3Result = item.s3Result || '';

  // è³ªå•ãƒ†ã‚­ã‚¹ãƒˆã‚’å¾©å…ƒ
  $('question').value = item.question || '';

  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆå…¨ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†ï¼‰
  setProgress(5);

  // Step 1 æç”»
  if (s1Data) {
    $('sec1').classList.add('show');
    AIs.forEach(n => {
      if (s1Data[n]) renderCard(`s1-${n}`, `stat1-${n}`, `c1-${n}`, `q1-${n}`, s1Data[n]);
    });
  }

  // Facilitator æç”»
  if (fData) {
    $('secF').classList.add('show');
    renderFacilitator(fData);
    $('facilitate-footer').style.display = 'flex';
    $('btn-proceed').disabled = true;
  }

  // Step 2 æç”»
  if (s2Data) {
    $('sec2').classList.add('show');
    AIs.forEach(n => {
      if (s2Data[n]) renderCard(`s2-${n}`, `stat2-${n}`, `c2-${n}`, `q2-${n}`, s2Data[n]);
    });
  }

  // Step 3 æç”»
  if (s3Result) {
    $('sec3').classList.add('show');
    if (s1Data && s2Data) renderContrib(s1Data, s2Data);
    $('final-body').innerHTML = marked.parse(s3Result);
  }

  // è¿½åŠ è³ªå•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
  $('sec-followup').classList.add('show');

  // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¦ãƒšãƒ¼ã‚¸å…ˆé ­ã¸
  toggleHistoryPanel();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// èµ·å‹•æ™‚ã«ãƒãƒƒã‚¸æ›´æ–°
updateHistBadge();

// Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ
$('question').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    if (!$('btn-start').disabled) startDiscussion();
  }
});
</script>
</body>
</html>
